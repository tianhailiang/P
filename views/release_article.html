
<!DOCTYPE html>
<html lang="en">
<head>
  {% include "header_new.html" %}
  <link rel="stylesheet" href="{{helper.cdnhost}}/assets/css/release_article.css" >
  <!--[if lt IE 10]>
  <script src="{{helper.cdnhost}}/assets/js/upgrade.js"></script>
  <![endif]-->
</head>
<body style="background:#f5f5f5;">
	<!-- ===头部=== -->
	{% include "widget/top/top.html" %}
	<!-- ====导航===== -->
	{% import "widget/nav_seventh/nav_seventh.html" as nav_seventh %}
	{{nav_seventh.nav_seventh("#",tdk.cityid,helper)}}
	<div class="dui-layout-lg clearfix" style="margin-top: 20px;">
  	<!-- ==广告1== -->
  	<div class="rel-case-map" id="AD_{% if login_info.usertype == 2 %}ADVISOR{% elif login_info.usertype == 3 %}CANZAN{% endif %}_CENTER_POSTARTICLE_SEAT1">
  	</div>
	</div>
	<div class="dui-layout-lg clearfix dui-layout-padding" >
	  <div class="dui-layout-silde ">
	    <!-- =======顾问头像关注====== -->
      {% import "widget2/community_advisor/community_advisor.html" as community_advisor %}
      {% if userinfo.usertype == 2 %}
        {{community_advisor.advisor(userinfo, helper,login_info)}}
      {% elif userinfo.usertype == 3 %}  
        {{community_advisor.counsellor(userinfo, helper,login_info)}}
      {% else %}  
      {% endif %}
	    <!-- ========引入顾问侧边栏按钮======== -->
      {% if login_info.usertype ==2 %}
        {% import "widget2/side_menu/adviser_side_menu.html" as adviser_side_menu %}
        {{ adviser_side_menu.adviser_side_menu('发布专栏','',helper) }} 
      {% elif login_info.usertype == 3 %}
        {% import "widget2/side_menu/canzan_side_menu.html" as canzan_side_menu %}
        {{ canzan_side_menu.canzan_side_menu('发布专栏','',helper) }} 
      {% endif %}
	  </div>
	  <div class="dui-layout-div"></div>
      <div class="dui-layout-con dui-box-shadow" >
        <div class="rel-case-con" >
	        <div class="main-title gray-bg">
		        <h3 style="font-size: 18px;">专栏发布</h3>
	        </div>
  	      <div class="rel-case-list" >
            <div class="rel-case-text1" style="margin-top: 20px;">
              <label class="title active" for="art_type"><span>*</span> 选择文章发布类型：</label>
              {% set artType = [
                {"id":"11","txt":"留学聚焦"},
                {"id":"12","txt":"申请攻略"},
                {"id":"13","txt":"签证指导"},
                {"id":"14","txt":"申请条件"},
                {"id":"15","txt":"留学费用"},
                {"id":"16","txt":"专家解读"}
              ] %}
              <select id="art_type">
                <option value="" >请选择文章发布类型</option>
                {% for item in artType %}
                  <option value="{{item.id}}">{{item.txt}}</option>
                {% endfor %}
              </select>
              <span class="numTip" ></span>
            </div>  
            <div class="rel-case-text1" style="margin-top: 20px;">
              <label class="title active" for="apply-country">
                <span>*</span> 选择文章对应国家：
              </label>
              {% set countryList = [
                {"countryId":"1","txt":"美国"},
                {"countryId":"2","txt":"英国"},
                {"countryId":"3","txt":"加拿大"},
                {"countryId":"4","txt":"澳大利亚"},
                {"countryId":"5","txt":"新西兰"},
                {"countryId":"50","txt":"韩国"},
                {"countryId":"51","txt":"日本"},
                {"countryId":"52","txt":"新加坡"},
                {"countryId":"53","txt":"马来西亚"},
                {"countryId":"54","txt":"中国香港"},
                {"countryId":"100","txt":"俄罗斯"},
                {"countryId":"101","txt":"乌克兰"},
                {"countryId":"102","txt":"白俄罗斯"},
                {"countryId":"103","txt":"德国"},
                {"countryId":"104","txt":"法国"},
                {"countryId":"105","txt":"挪威"},
                {"countryId":"106","txt":"瑞典"},
                {"countryId":"107","txt":"芬兰"},
                {"countryId":"108","txt":"爱尔兰"},
                {"countryId":"109","txt":"荷兰"},
                {"countryId":"110","txt":"丹麦"},
                {"countryId":"111","txt":"意大利"},
                {"countryId":"112","txt":"西班牙"},
                {"countryId":"113","txt":"瑞士"}
              ] %}
              <select id="apply-country" >
                <option value="">请选择国家</option>
                {% for item in countryList %}
                  <option value="{{item.countryId}}">{{item.txt}}</option>
                {% endfor %}
              </select>
              <span class="numTip" ></span>
            </div>
            <div class="rel-case-text1 clearfix" style="margin-top: 20px;height: auto;">
              <label class="title active" style="float:left;" >
                <span>*</span> 点击选择文章配图：
              </label>
              <div class="figure">
                <img src="" id ="figure-img" />
                <a  href="javascript:" class="figure_delete iconfont" title="删除" >
                  &#xe8c1;
                </a>
              </div>
              <label class="figure-label" >
                <i class="iconfont add-icon">&#xe616;</i>
              </label>
              <span class="numTip" style="float:left;margin-left:10px;margin-top:120px;">
                 注：选择图片库对应的文章配图
              </span>
            </div>
  	        <div class="rel-case-text1" style="margin-top: 20px;">
      			  <label class="title active" for="rel-case-title">
                <span>*</span> 文章标题：
              </label>
      			  <input  id="rel-case-title" type="text" maxlength="30">
      			  <span class="numTip" style="display: block;margin-left: 97px;">填写文章标题，字数限30个汉字</span>
      		  </div>
            <div class="rel-case-text1" style="margin-top: 20px;">
              <label class="title active" for="rel-keyword" style="letter-spacing: 4.8px;">
                <span>*</span> 关键词：
              </label>
              <input  id="rel-keyword" type="text" >
              <span class="numTip" style="display: block;margin-left: 97px;">
                多关键词之间用 "," 隔开
              </span>
            </div>
            <div class="rel-case-text1" style="margin-top: 20px;">
              <label class="title active" for="art_abs" >
                <span>*</span> 文章摘要：
              </label>
              <textarea class="art_abs" id="art_abs" maxlength="200"></textarea>
              <div class="word-num">还可以输入<span id="word-num">200</span>字</div>
              <span class="numTip" style="display: block;margin-left: 97px;">
                填写文章内容概要信息，此内容将会在网站与个人主页显示，请认真填写
              </span>
            </div>
    		    <div class="rel-case-text1 clearfix" style="margin-top: 20px;" >
    			    <label class="title active" style="float:left">
                <span>*</span> 正文内容：
              </label>
              <div class="editor">
      			    <div id="editor" style="border-bottom:1px solid #dcdcdc;">    
                </div>
                <div id="editor1" >
                </div>
              </div>  
            </div>
            <div class="editor-btn-box" >
              <a  href="javascript:void(0);" class="dui-btn btn-xlarge btn-appointment" style="margin-right: 7px;" id="save-draft">
                    保存到草稿
              </a>
              <a  href="javascript:void(0);" class="dui-btn btn-xlarge btn-appointment" id="sureBtn">
                   	确定发布
              </a>
            </div>
          </div>  
          <!-- ====rel-case-con end===== -->
        </div>
      </div>
	</div>
  <!-- ====弹窗图片库==== -->
  <div class="pic-lib" >
    <div class="pic-lib-top" >
      文章配图上传
    </div> 
    <div class="pic-lib-con" >
      <div class="pic-con-top clearfix" >
        <span class="pic-con-top-left">图库</span>
        <span class="pic-con-top-right" id= "paging">
          <i class="iconfont">&#xe65f;</i>
          换一批
        </span>
      </div>
      <ul class="pic-con-ul clearfix">
      </ul>
      <div class="pic-lib-btn" >
        <a  href="javascript:void(0);" class="dui-btn btn-xlarge btn-appointment pic-srue-btn">确定</a>
        <a  href="javascript:void(0);" class="dui-btn btn-xlarge pic-cancel-btn">取消</a>
      </div>
    </div>
  </div>
  {% include "widget/footer/footer.html" %}
  <script>
    var login_ss = null; //获取用户信息
    if($.cookie('login_ss') != undefined){
      login_ss = JSON.parse($.cookie('login_ss'));  
    }
  </script>
  <script src="{{helper.cdnhost}}/assets/js/show_advert.js"></script>
  <script src="{{helper.cdnhost}}/assets/js/nav_seventh.js" ></script>
  <script  src="{{helper.cdnhost}}/assets/js/wangEditor.js"></script>
  <script src="{{helper.cdnhost}}/assets/js/layer.min.js"></script>
  <script src="{{helper.cdnhost}}/assets/js/follow.js"></script>
  <script src="{{helper.cdnhost}}/assets/js/footer.js"></script>
  <script >
    $(function(){
      var city_id =null;
      if(login_ss.usertype ==2){
        //获取顾问的组织id
        city_id = $(".advisor-bumen").attr("data-cityId");
      }else if(login_ss.usertype == 3){
        //参赞默认为1 北京分公司
        city_id =1;
      }
      $("#art_abs").on("change",function(){
        this.value = this.value.substring(0, 200);
      }); 
      $("#art_abs").on("keydown",function(){
        this.value  = this.value.substring(0, 200);
      }); 
      $("#art_abs").on("keyup",function(){
        var strLength = $.trim($(this).val()).length; 
        $("#word-num").html(200-strLength);
        if(strLength > 200){
          $("#word-num").html(0);
          this.value  = this.value.substring(0, 200);
        }
      }); 
      var picFlag = false;
      var picSrc = null;
      var picDataSrc =null;
      var page = 0;
      //点击弹出图片选择框
      $(".figure-label").on("click",getPicData);
      function getPicData(){
        if($("#art_type").val()==''){
          // 判断文章发布类型
          layer.msg('请选择文章发布类型');
          return false;
        }else{
          page++;
          // console.log(page)
          $.ajax({
            url:'/soapi/attachment',
            type:"GET",
            dataType:"json",
            data:{
              catid:$("#art_type").val(),
              page:page
            },
            success:function(result){
              console.log(result)
              if(result.code == 0){
                $('.pic-con-ul').html(null);//清空一次
                var html = '';
                for(var i =0;i<result.data.list.length;i++){
                  html += '<li>'+
                            '<img src="'+fn.imageThumb(result.data.list[i].thumb,'150x150')+'" data-src="'+result.data.list[i].thumb+'">'+
                            '<span class="check-box iconfont" ></span>'+
                         '</li>';
                }
                $('.pic-con-ul').append(html);
                $(".pic-con-ul li").eq(3).css({marginRight:0});
                $(".pic-con-ul li").eq(7).css({marginRight:0});
                $(".pic-lib").show();
                $(".pic-con-ul li").on("click",function(){
                  //图片选择点击
                  $(".pic-con-ul li").find("span").removeClass('sel-active');
                  $(".pic-con-ul li").find("span").html('');
                  $(".pic-con-ul li").removeAttr('data-checked');
                  $(this).find("span").addClass('sel-active');
                  $(this).find("span").html('<i class="iconfont check-mark-icon" >&#xe652;</i>');
                  picFlag = true;
                  picSrc = $(this).find('img').attr("src");
                  picDataSrc = $(this).find('img').attr("data-src");
                });

              }else{
                
              }
            },
            error:function(XMLHttpRequest, textStatus, errorThrown){
              console.log(errorThrown)
            }  
          })
        }  
      }
      $(".pic-srue-btn").on("click",function(){
        //点击确定
        if(picFlag){
          $(".pic-lib").hide();
          $(".figure-label").hide();
          $('.figure').show();
          $('.figure').find("img").attr("src",picSrc);
          $('.figure').find("img").attr("data-src",picDataSrc);
        }else{
          layer.msg("请选择一张图片");
        }
      });
      $(".pic-cancel-btn").on("click",function(){
        //点击取消
        $(".pic-lib").hide();
      });
      $('.figure_delete').on("click",function(){
        // 删除
        $(this).prev().attr("src",'');
        $(this).parent().hide();
        $(".figure-label").show();
        $(".pic-con-ul li").removeAttr('data-checked');
        $(".pic-con-ul li span").removeClass('sel-active');
        $(".pic-con-ul li span").html('');
        picFlag = false;
      });
      $("#paging").on("click",getPicData); //点击换一批 
      //编辑器
      var E = window.wangEditor;
      var editor = new E('#editor','#editor1');
      // 或者 var editor = new E( document.getElementById('#editor') )
      // 自定义菜单配置
      editor.customConfig.menus = [   
        'bold',  // 粗体
        'italic',  // 斜体
        'underline',  // 下划线
        'strikeThrough',  // 删除线
        'foreColor',  // 文字颜色
        'backColor',  // 背景颜色
        'link',  // 插入链接
        'list',  // 列表
        'justify',  // 对齐方式
        'image',  // 插入图片
        'table',  // 表格
        'undo',  // 撤销
        'redo'  // 重复
      ];
      editor.customConfig.debug = false;
      // 关闭粘贴样式的过滤
      editor.customConfig.pasteFilterStyle = false;
      editor.customConfig.uploadFileName = 'upload';
      // 将图片大小限制为 500K
      editor.customConfig.uploadImgMaxSize = 500 * 1024;
      // 限制一次最多上传 5 张图片
      editor.customConfig.uploadImgMaxLength = 1;
      editor.customConfig.uploadImgServer = ajaxUrlPrefix.nodeapi + "/cmsapi/input_upload"; // 上传图片到服务器
      // 隐藏“网络图片”tab
      editor.customConfig.showLinkImg = false;
      editor.customConfig.uploadImgHooks = {
        before: function (xhr, editor, files) { 
        },
        success: function (xhr, editor, result) {
        },
        fail: function (xhr, editor, result) {
        },
        error: function (xhr, editor) {
          console.log(xhr)
        },
        timeout: function (xhr, editor) {
        },
        customInsert: function (insertImg, result, editor) {
          console.log(result)
          var url = result.data[0];
          insertImg(url)
        }
      }
      editor.customConfig.customAlert = function (info) {
        // info 是需要提示的内容
        layer.msg(info)
      }
      editor.create();
      $('#sureBtn').on('click', function () {
        // 读取 html
        var data = editor.txt.html();
        if($("#art_type").val()==''){
          // 判断文章发布类型
          $("#art_type").focus();
          $("#art_type").next().html("请选择文章发布类型");
          return false;
        }else{
          $("#art_type").next().html('');
        }  
        if($("#apply-country").val()==''){
        	// 判断国家
        	$("#apply-country").focus();
          $("#apply-country").next().html("请选择国家");
          return false;
        }else{
        	 $("#apply-country").next().html('');
        } 
        if($("#figure-img").attr('data-src')=='' || $("#figure-img").attr('data-src')==undefined){
          // 判断文章配图
          layer.msg('请选择文章配图');
          return false;
        }
        if($("#rel-case-title").val()==''){
          // 判断title
          $("#rel-case-title").focus();
          $("#rel-case-title").next().html("请填写文章标题，字数限30个汉字");
          return false;
        }else{
          $("#rel-case-title").next().html('填写文章标题，字数限30个汉字');
        }
        if($("#rel-keyword").val()==''){
          //判断关键词
          $("#rel-keyword").focus();
          $("#rel-keyword").next().html("请填写关键词");
          return false;
        }else{
          $("#rel-keyword").next().html('多关键词之间用空格或者 "," 隔开');
        }
        if($("#art_abs").val()==''){
          // 判断文章摘要
          $("#art_abs").focus();
          $("#art_abs").next().next().html("请填写文章摘要");
          return false;
        }else{
          $("#art_abs").next().next().html('填写文章内容概要信息，此内容将会在网站与个人主页显示，请认真填写');
        }
        if($("#editor1").find("p").html() == '<br>'){
          //判断正文
          layer.msg("请输入正文内容");
          return false;
        }
        var region = '';
        if(Number($("#apply-country").val()) >=50 && Number($("#apply-country").val()) <100){
          region = 201;
        }else if(Number($("#apply-country").val()) >= 100){
          region =202;
        }    
        $.ajax({
          url: '/soapi/publish_article',
          type:'POST',
          data:{
            city_id:city_id,
            u_id:login_ss.uid,
            category_id:$("#art_type").val(),
            thumb:$("#figure-img").attr('data-src'),	
            title:$.trim($("#rel-case-title").val()),
            keywords:$.trim($("#rel-keyword").val()),
            country_id:$("#apply-country").val(),
            type:2,
            is_draft:1,
            desc:$.trim($("#art_abs").val()),
            messasge:data,
            region:region
          },
          dataType:'json',
          success:function(result){
            console.log(result)
            if(result.code == 0){
            	layer.msg('发布成功')
            }else if(result.code == '1210000011'){
              layer.msg('标题已存在，请更换标题');
            }else if(result.code == '1210000012'){
              layer.msg('您编辑器输入的内容有敏感词');
            }else{
              layer.msg('发布失败')
            }
          },
          error:function(XMLHttpRequest, textStatus, errorThrown){
            console.log(errorThrown)
            if(XMLHttpRequest.status == '413'){
              layer.msg('您发布的内容已超过1M，应小于1M');
            }
          }
        });
      });
      $("#save-draft").on("click",function(){
        //保存草稿箱
        var data = editor.txt.html();
        if($("#art_type").val()==''){
          // 判断title
          $("#art_type").focus();
          $("#art_type").next().html("请选择文章发布类型");
          return false;
        }else{
          $("#art_type").next().html('');
        }  

        if($("#apply-country").val()==''){
          // 判断国家
          $("#apply-country").focus();
          $("#apply-country").next().html("请选择国家");
          return false;
        }else{
          $("#apply-country").next().html('');
        }
        if($("#figure-img").attr('data-src')=='' || $("#figure-img").attr('data-src')==undefined){
          // 判断文章配图
          layer.msg('请选择文章配图');
          return false;
        }
        if($("#rel-case-title").val()==''){
          // 判断title
          $("#rel-case-title").focus();
          $("#rel-case-title").next().html("填写文章标题，字数限30个汉字");
          return false;
        }else{
          $("#rel-case-title").next().html('填写文章标题，字数限30个汉字');
        }
        if($("#rel-keyword").val()==''){
          //判断关键词
          $("#rel-keyword").focus();
          $("#rel-keyword").next().html("请填写关键词");
          return false;
        }else{
          $("#rel-keyword").next().html('多关键词之间用空格或者 "," 隔开');
        }
        if($("#art_abs").val()==''){
          // 判断文章摘要
          $("#art_abs").focus();
          $("#art_abs").next().next().html("请填写文章摘要");
          return false;
        }else{
          $("#art_abs").next().next().html('填写文章内容概要信息，此内容将会在网站与个人主页显示，请认真填写');
        }

        if($("#editor1").find("p").html() == '<br>'){
          //判断正文
          layer.msg("请输入正文内容");
          return false;
        } 
        var region = '';
        if(Number($("#apply-country").val()) >=50 && Number($("#apply-country").val()) <100){
          region = 201;
        }else if(Number($("#apply-country").val()) >= 100){
          region =202;
        }       

        $.ajax({
          url: '/soapi/publish_article',
          type:'POST',
          data:{
              city_id:city_id,
              u_id:login_ss.uid,
              category_id:$("#art_type").val(),
              thumb:$("#figure-img").attr('data-src'), 
              title:$.trim($("#rel-case-title").val()),
              keywords:$.trim($("#rel-keyword").val()),
              country_id:$("#apply-country").val(),
              type:2,
              is_draft:2,
              desc:$.trim($("#art_abs").val()),
              messasge:data,
              region:region
          },
          dataType:'json',
          success:function(result){
            console.log(result)
            if(result.code == 0){
              layer.msg('保存草稿成功')
              window.setTimeout(function(){
                if(login_ss.usertype == 2){
                  window.location.href='/advisor_center/draft'; 
                }else if(login_ss.usertype == 3){
                  window.location.href='/canzan_center/draft'; 
                } 
              },1000);
            }else if(result.code == '1210000011'){
              layer.msg('标题已存在，请更换标题');
            }else if(result.code == '1210000012'){
              layer.msg('您编辑器输入的内容有敏感词');
            }else{
              layer.msg('保存失败')
            }
          },
          error:function(XMLHttpRequest, textStatus, errorThrown){
            console.log(errorThrown)
            if(XMLHttpRequest.status == '413'){
              layer.msg('您发布的内容已超过1M，应小于1M');
            }
          }
        });
      });
    })
 </script>
</body>
</html>